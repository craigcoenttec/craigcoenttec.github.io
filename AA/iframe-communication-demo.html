<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iframe Communication Demo - Learning Example</title>
    <!-- Genesys PureCloud SDK -->
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
        }
        
        .demo-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .main-content {
            display: flex;
            gap: 10px;
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            min-height: 0;
        }
        
        .controls-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 0 0 450px;
            overflow-y: auto;
            box-sizing: border-box;
            max-height: 100%;
        }
        
        .iframe-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .demo-iframe {
            width: 100%;
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 4px;
            min-height: 0;
        }
        
        .button-group {
            margin: 10px 0;
        }
        
        .demo-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .demo-button:hover {
            background: #0056b3;
        }
        
        .demo-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* Larger display area for conversation details */
        #conversationDetailsLog {
            max-height: 400px;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        
        .input-group input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .description {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196f3;
            margin-bottom: 20px;
        }
        
        /* Form panel toggle styles */
        .controls-panel.hidden {
            display: none;
        }
        
        .panel-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .toggle-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-button:hover {
            background: #218838;
        }
        
        .toggle-button.hide-mode {
            background: #dc3545;
        }
        
        .toggle-button.hide-mode:hover {
            background: #c82333;
        }
        
        /* Collapsible header styles */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0 5px 0;
            transition: background-color 0.2s ease;
            border-left: 4px solid #007bff;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }
        
        .collapsible-header:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }
        
        .collapsible-header h3 {
            margin: 0;
            color: #495057;
            font-size: 16px;
        }
        
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            /* Default to collapsed state - will be overridden by JavaScript if needed */
            max-height: 0;
        }
        
        .collapsible-content.collapsed {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        
        /* Default indicator to collapsed state */
        .collapsible-indicator {
            font-size: 14px;
            font-weight: bold;
            color: #007bff;
            transition: transform 0.2s ease;
            /* Default to collapsed (rotated) state */
            transform: rotate(-90deg);
        }
        
        .collapsible-indicator.collapsed {
            transform: rotate(-90deg);
        }
        
        /* When expanded, rotate indicator back to down arrow */
        .collapsible-indicator:not(.collapsed) {
            transform: rotate(0deg);
        }
        
        .section-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        

        <div class="main-content">
            <div class="controls-panel">
            <h2>Communication Controls</h2>
            
            <!-- Connection Status -->
            <div class="input-group">
                <label>Connection Status:</label>
                <span id="connectionStatus">Not Connected</span>
            </div>
            
            <!-- Active Conversation ID from iframe response -->
            <div class="input-group">
                <label>Active Conversation ID:</label>
                <span id="activeConversationId" style="font-family: monospace; background: #f8f9fa; padding: 2px 5px; border: 1px solid #ddd;">None</span>
            </div>
            
            <div class="input-group">
                <label>Iframe Base URL:</label>
                <input type="text" id="iframeUrlInput" value="https://agent-assist.tthcslabs.com" placeholder="Enter iframe base URL">
            </div>
            
            <div class="input-group">
                <label>Organization ID:</label>
                <input type="text" id="organizationIdInput" value="01981384-048a-7074-9d2b-ba9100330a08" placeholder="Enter organization ID">
            </div>
            
            <div class="input-group">
                <button class="demo-button" onclick="loadIframeWithNewUrl()">Load Iframe</button>
                <button class="demo-button" onclick="startNewCallSequence()" style="background: #e67e22; margin-left: 10px;">🚀 New Call</button>
                <button class="demo-button" onclick="startAutoListenSequence()" style="background: #17a2b8; margin-left: 10px;">👂 Auto Listen</button>
            </div>
            
            <!-- New Call Sequence Status -->
            <div class="input-group">
                <label>Call Sequence Status:</label>
                <div id="callSequenceStatus" style="font-family: monospace; background: #f8f9fa; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px; font-size: 12px;">Ready to start new call sequence</div>
            </div>

            <!-- AudioHook Configuration -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('audiohookSection')">
                    <h3>AudioHook Integration</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="audiohookSection">
                
                    <div class="input-group">
                        <label>AudioHook WebSocket URL:</label>
                        <input type="text" id="audiohookUrlInput" value="wss://ttec-digital-audiohook-listener-638069638150.us-central1.run.app/api/v1/client/ws" placeholder="Enter AudioHook WebSocket URL" style="width: 400px;">
                    </div>
                    
                    <div class="input-group">
                        <label>AudioHook Status:</label>
                        <span id="audiohookStatus" style="font-family: monospace; background: #f8f9fa; padding: 2px 5px; border: 1px solid #ddd;">Disconnected</span>
                        <button class="demo-button" onclick="connectToAudiohook()" id="audiohookConnectBtn">Connect AudioHook</button>
                        <button class="demo-button" onclick="disconnectFromAudiohook()" id="audiohookDisconnectBtn" disabled>Disconnect AudioHook</button>
                    </div>
                    
                    <!-- AudioHook Message Log -->
                    <div style="margin-top: 15px;">
                        <h4 style="margin: 10px 0 5px 0; color: #495057;">Message Log</h4>
                        <div id="audiohookMessageLog" class="status-display">
                            Ready to receive AudioHook messages...
                        </div>
                        <button class="demo-button" onclick="clearAudiohookLog()" style="background: #dc3545; margin-top: 5px;">Clear AudioHook Log</button>
                    </div>
                
                </div>
            </div>

            <!-- Genesys Cloud Functions -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('genesysCloudSection')">
                    <h3>Genesys Cloud Functions</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="genesysCloudSection">
                
                    <!-- Genesys Cloud Transcription -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Transcription Configuration</h4>
                        
                        <div class="input-group">
                            <label>GC Region:</label>
                            <input type="text" id="gcRegionInput" value="usw2.pure.cloud" placeholder="Enter Genesys Cloud region (e.g., mypurecloud.com)">
                        </div>
                        
                        <div class="input-group">
                            <label>GC Client ID:</label>
                            <input type="text" id="gcClientIdInput" value="Add Client ID" placeholder="Enter Genesys Cloud Client ID" style="width: 300px;">
                        </div>
                        
                        <div class="input-group">
                            <label>GC Redirect URL:</label>
                            <input type="text" id="gcRedirectUrlInput" value="" placeholder="Will be auto-filled with current URL" style="width: 400px;">
                        </div>
                        
                        <div class="input-group">
                            <label>GC Conversation ID:</label>
                            <input type="text" id="gcConversationIdInput" value="" placeholder="Enter Genesys Cloud Conversation ID" style="width: 300px;">
                        </div>
                        
                        <div class="input-group">
                            <label>GC Auth Status:</label>
                            <span id="gcAuthStatus" style="font-family: monospace; background: #f8f9fa; padding: 2px 5px; border: 1px solid #ddd;">Not Authenticated</span>
                        </div>
                        
                        <div class="input-group">
                            <label>GC Transcription Status:</label>
                            <span id="gcTranscriptionStatus" style="font-family: monospace; background: #f8f9fa; padding: 2px 5px; border: 1px solid #ddd;">Disconnected</span>
                            <button class="demo-button" onclick="authenticateGenesysCloud()" id="gcAuthBtn">Authenticate GC</button>
                            <button class="demo-button" onclick="connectToTranscription()" id="gcTranscriptionConnectBtn" disabled>Connect Transcription</button>
                            <button class="demo-button" onclick="disconnectFromTranscription()" id="gcTranscriptionDisconnectBtn" disabled>Disconnect Transcription</button>
                        </div>
                    </div>

                    <!-- Genesys Cloud Conversation Notifications -->
                    <div style="margin: 20px 0; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Conversation Notifications</h4>
                        
                        <div class="input-group">
                            <label>GC User ID:</label>
                            <input type="text" id="gcUserIdInput" value="f1804415-bca9-4eb7-ad5a-521fca8d6128" placeholder="Enter Genesys Cloud User ID" style="width: 300px;">
                        </div>
                        
                        <div class="input-group">
                            <label>GC Conversation Status:</label>
                            <span id="gcConversationStatus" style="font-family: monospace; background: #f8f9fa; padding: 2px 5px; border: 1px solid #ddd;">Disconnected</span>
                            <button class="demo-button" onclick="connectToConversationNotifications()" id="gcConversationConnectBtn" disabled>Connect Conversations</button>
                            <button class="demo-button" onclick="disconnectFromConversationNotifications()" id="gcConversationDisconnectBtn" disabled>Disconnect Conversations</button>
                        </div>
                    </div>
                    
                    <!-- Genesys Cloud Message Notifications -->
                    <div style="margin: 20px 0; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Message Notifications</h4>
                        
                        <div class="input-group">
                            <label>GC Message Status:</label>
                            <span id="gcMessageStatus" style="font-family: monospace; background: #f8f9fa; padding: 2px 5px; border: 1px solid #ddd;">Disconnected</span>
                            <button class="demo-button" onclick="connectToMessageNotifications()" id="gcMessageConnectBtn" disabled>Connect Messages</button>
                            <button class="demo-button" onclick="disconnectFromMessageNotifications()" id="gcMessageDisconnectBtn" disabled>Disconnect Messages</button>
                        </div>
                    </div>
                    
                    <!-- Genesys Cloud Transcription Log -->
                    <div style="margin: 20px 0; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Transcription Log</h4>
                        <div id="gcTranscriptionMessageLog" class="status-display">
                            Ready to receive Genesys Cloud transcription messages...
                        </div>
                        <button class="demo-button" onclick="clearGcTranscriptionLog()" style="background: #dc3545; margin-top: 5px;">Clear GC Transcription Log</button>
                    </div>
                    
                    <!-- Genesys Cloud Conversation Notifications Log -->
                    <div style="margin: 20px 0; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Conversation Notifications Log</h4>
                        <div id="gcConversationNotificationLog" class="status-display">
                            Ready to receive Genesys Cloud conversation notifications...
                        </div>
                        <button class="demo-button" onclick="clearGcConversationNotificationLog()" style="background: #dc3545; margin-top: 5px;">Clear GC Conversation Log</button>
                    </div>
                    
                    <!-- Message Tracker -->
                    <div style="margin: 20px 0; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Message Tracker</h4>
                        <div id="messageTrackerDisplay" class="status-display" style="max-height: 300px;">
                            No messages tracked yet...
                        </div>
                        <button class="demo-button" onclick="clearMessageTracker()" style="background: #dc3545; margin-top: 5px;">Clear Message Tracker</button>
                    </div>
                
                </div>
            </div>

            <!-- Authorization Functions -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('authFunctionsSection')">
                    <h3>Authorization Functions</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="authFunctionsSection">
                <div class="button-group">
                    <button class="demo-button" onclick="sendAuthorizeMessage()">Send Authorization Request</button>
                    <button class="demo-button" onclick="simulateAuthSuccess()">Simulate Auth Success</button>
                    <button class="demo-button" onclick="simulateConversationJoined()">Simulate Conversation Joined</button>
                </div>
                </div>
            </div>

            <!-- Agent Assist Management Functions -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('conversationMgmtSection')">
                    <h3>Agent Assist Management Functions</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="conversationMgmtSection">
                <div class="button-group">
                <div class="input-group">
                    <label>AA Conv ID:</label>
                    <input type="text" id="conversationIdInput" value="qrvn6sjly4a74x07" placeholder="Enter Agent Assist conversation ID">
                </div>
                <div class="input-group">
                    <label>Profile ID:</label>
                    <input type="text" id="conversationProfileIdInput" value="0198e667-6540-727d-b6b0-d8f4de9db1c6" placeholder="Enter conversation profile ID">
                </div>
                <div class="input-group">
                    <label>Contact Name:</label>
                    <input type="text" id="contactNameInput" value="John Doe" placeholder="Enter contact name">
                </div>
                <div class="input-group">
                    <label>Contact Email:</label>
                    <input type="text" id="contactEmailInput" value="john.doe@example.com" placeholder="Enter contact email">
                </div>
                <div class="input-group">
                    <label>Contact Phone:</label>
                    <input type="text" id="contactPhoneInput" value="5551112222" placeholder="Enter contact phone">
                </div>
                <button class="demo-button" onclick="sendJoinConversationMessage()">Join Conversation</button>
                <button class="demo-button" onclick="sendActivateConversationMessage()">Activate Conversation</button>
                <button class="demo-button" onclick="sendLeaveConversationMessage()">Leave Conversation</button>
                
                <!-- Content Analysis -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">Content Analysis</h4>
                    <div class="input-group">
                        <label>Message Content:</label>
                        <input type="text" id="messageContentInput" value="Hello, how can I help you today?" placeholder="Enter message content">
                    </div>
                    <div class="input-group">
                        <label>Participant Type:</label>
                        <select id="speakerTypeSelect">
                            <option value="HUMAN_AGENT">HUMAN_AGENT (Agent)</option>
                            <option value="END_USER">END_USER (Customer)</option>
                        </select>
                    </div>
                    <button class="demo-button" onclick="sendAnalyzeContentMessage()">Analyze Content</button>
                </div>
                
                <!-- Conversation Wrap Up -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">Conversation Wrap Up</h4>
                    <button class="demo-button" onclick="sendWrapConversationMessage()">Wrap Conversation</button>
                </div>
                
                <!-- Message Log -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">Message Log</h4>
                    <div id="messageLog" class="status-display">
                        Ready to send messages to iframe...
                    </div>
                    <button class="demo-button" onclick="clearMessageLog()" style="background: #dc3545; margin-top: 5px;">Clear Log</button>
                </div>
                
                </div>
                </div>
            </div>




            <!-- Conversation Tracking Display -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('trackedConversationsSection')">
                    <h3>Tracked Conversations</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="trackedConversationsSection">
                    <div class="input-group">
                        <button class="demo-button" onclick="clearTrackedConversations()" style="background: #dc3545;">Clear Tracked Conversations</button>
                    </div>
                    <div id="trackedConversationsDisplay" class="status-display" style="max-height: 400px;">
                        No conversations tracked yet...
                    </div>
                </div>
            </div>

            <!-- Conversation Details -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('conversationDetailsSection')">
                    <h3>Conversation Details</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="conversationDetailsSection">
                    <div class="input-group">
                        <button class="demo-button" onclick="getConversationDetails()" id="getConversationDetailsBtn">Get Conversation Details</button>
                    </div>
                    <div id="conversationDetailsLog" class="status-display">
                        Ready to fetch conversation details...
                    </div>
                    <button class="demo-button" onclick="clearConversationDetailsLog()" style="background: #dc3545;">Clear Conversation Details Log</button>
                </div>
            </div>

            <!-- Latest Notes Display -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('latestNotesSection')">
                    <h3>Latest Notes from Iframe</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="latestNotesSection">
                    <div id="latestNotesDisplay" class="status-display" style="max-height: 300px;">
                        No notes received yet...
                    </div>
                    <button class="demo-button" onclick="clearLatestNotes()" style="background: #dc3545;">Clear Notes</button>
                </div>
            </div>

            <!-- Auto-Forwarding Controls -->
            <div class="section-container">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('autoForwardingSection')">
                    <h3>Auto-Forwarding to Iframe</h3>
                    <span class="collapsible-indicator">▼</span>
                </div>
                <div class="collapsible-content" id="autoForwardingSection">
            <div class="input-group">
                <label>
                    <input type="checkbox" id="autoForwardTranscription" checked onchange="toggleAutoForwardTranscription()" style="margin-right: 8px;">
                    Auto-forward GC Transcription to iframe
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="autoForwardAudiohook" checked onchange="toggleAutoForwardAudiohook()" style="margin-right: 8px;">
                    Auto-forward AudioHook messages to iframe
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="autoForwardMessages" checked onchange="toggleAutoForwardMessages()" style="margin-right: 8px;">
                    Auto-forward Genesys Cloud messages to iframe for analysis
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="filterWorkflowMessages" checked onchange="toggleFilterWorkflowMessages()" style="margin-right: 8px;">
                    Filter out workflow messages from analysis (exclude bot/system messages)
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="autoHandleIncomingCalls" checked onchange="toggleAutoHandleIncomingCalls()" style="margin-right: 8px;">
                    Auto-handle incoming calls (transcription + join + activate)
                </label>
            </div>
                </div>
            </div>
            </div>

            <div class="iframe-container">
                <div class="panel-toggle">
                    <h2 style="margin: 0;">TTEC Agent Assist</h2>
                    <button id="panelToggleBtn" class="toggle-button" onclick="toggleFormPanel()">
                        <span>🔍</span>
                    </button>
                </div>
                <iframe id="demoIframe" class="demo-iframe" src="about:blank" allow="clipboard-write"></iframe>
            </div>
        </div>
    </div>

    <!-- Include the JavaScript file -->
    <script src="iframe-communication-wrapper.js"></script>
    
    <!-- 
    ==========================================================================
    TTEC AGENT ASSIST IFRAME COMMUNICATION DEMO
    ==========================================================================
    
    This demo demonstrates how a parent page communicates with an Agent Assist
    iframe using the postMessage API, similar to how the actual AA application
    works. It includes:
    
    - Iframe communication using postMessage API
    - AudioHook WebSocket integration for real-time transcription
    - Genesys Cloud Platform SDK integration for conversation management
    - Automated call sequence workflow
    - Auto-forwarding of transcription messages to iframe for analysis
    
    Architecture:
    - HTML: Form controls and iframe container
    - JavaScript: Communication wrapper and demo-specific logic
    - CSS: Responsive layout with form panel toggle
    
    URL Parameters Supported:
    - gc_region: Genesys Cloud region (e.g., mypurecloud.com)
    - gc_clientId: Genesys Cloud OAuth client ID
    - gc_redirectUrl: OAuth redirect URL (auto-filled if not provided)
    - gc_conversationId: Conversation ID (auto-starts sequence if provided)
    - audiohook_url: AudioHook WebSocket URL
    - iframe_url: Agent Assist iframe URL
    - organization_id: Organization ID for iframe URL construction
    - hidePanel: true/false to start with form panel hidden
    - AutoListen: true to auto-start listening sequence (load iframe + auth GC + start conversation subscription)
    
    ==========================================================================
    -->
    <script>
        "use strict";
        
        // ==========================================================================
        // GLOBAL VARIABLES & INITIALIZATION
        // ==========================================================================
        
        /** @type {Object} PureCloud Platform Client SDK reference */
        let platformClient = require('platformClient');
        
        /** @type {CCAIAgentAssistWrapper} Main communication wrapper instance */
        let communicationWrapper = null;
        
        /** @type {boolean} Flag to track if form panel is currently visible */
        let isFormPanelVisible = true;
        
        /** @type {boolean} Flag to prevent multiple concurrent call sequences */
        let callSequenceInProgress = false;
        
        /** @type {boolean} Flag to prevent multiple concurrent auto-listen sequences */
        let autoListenSequenceInProgress = false;
        
        /** @type {string} Store the detected conversation media type for call sequences */
        let lastDetectedMediaType = 'unknown';
        
        // ==========================================================================
        // URL PARAMETER HANDLING
        // ==========================================================================
        
        /**
         * Parses URL parameters and populates corresponding form fields
         * Supports Genesys Cloud, AudioHook, and iframe configuration parameters
         * Logs which fields were populated for debugging purposes
         */
        function populateFromUrlParameters() {
            const url = new URL(document.location.href);
            
            // Genesys Cloud parameters
            const gcRegion = url.searchParams.get('gc_region');
            const gcClientId = url.searchParams.get('gc_clientId');
            const gcRedirectUrl = url.searchParams.get('gc_redirectUrl');
            const gcConversationId = url.searchParams.get('gc_conversationId');
            
            // AudioHook parameters
            const audiohookUrl = url.searchParams.get('audiohook_url');
            
            // Iframe parameters
            const iframeUrl = url.searchParams.get('iframe_url');
            const organizationId = url.searchParams.get('organization_id');
            
            // Conversation parameters
            const conversationId = url.searchParams.get('conversation_id');
            const conversationProfileId = url.searchParams.get('conversation_profile_id');
            const contactName = url.searchParams.get('contact_name');
            const contactEmail = url.searchParams.get('contact_email');
            const contactPhone = url.searchParams.get('contact_phone');
            
            // Auto-listen parameter
            const autoListen = url.searchParams.get('AutoListen');
            
            // Populate Genesys Cloud fields
            if (gcRegion) {
                document.getElementById('gcRegionInput').value = gcRegion;
                sessionStorage.setItem('gc_region', gcRegion);
            }
            if (gcClientId) {
                document.getElementById('gcClientIdInput').value = gcClientId;
                sessionStorage.setItem('gc_clientId', gcClientId);
            }
            if (gcRedirectUrl) {
                document.getElementById('gcRedirectUrlInput').value = gcRedirectUrl;
                sessionStorage.setItem('gc_redirectUrl', gcRedirectUrl);
            }
            if (gcConversationId) {
                document.getElementById('gcConversationIdInput').value = gcConversationId;
                sessionStorage.setItem('gc_conversationId', gcConversationId);
            }
            
            // Populate AudioHook fields
            if (audiohookUrl) {
                document.getElementById('audiohookUrlInput').value = audiohookUrl;
            }
            
            // Populate iframe fields
            if (iframeUrl) {
                document.getElementById('iframeUrlInput').value = iframeUrl;
            }
            if (organizationId) {
                document.getElementById('organizationIdInput').value = organizationId;
            }
            
            // Populate conversation fields
            if (conversationId) {
                document.getElementById('conversationIdInput').value = conversationId;
            }
            if (conversationProfileId) {
                document.getElementById('conversationProfileIdInput').value = conversationProfileId;
            }
            if (contactName) {
                document.getElementById('contactNameInput').value = contactName;
            }
            if (contactEmail) {
                document.getElementById('contactEmailInput').value = contactEmail;
            }
            if (contactPhone) {
                document.getElementById('contactPhoneInput').value = contactPhone;
            }
            
            // Store AutoListen parameter in session storage for later use
            if (autoListen) {
                sessionStorage.setItem('auto_listen', autoListen);
            }
            
            // Log what was populated
            const populatedFields = [];
            if (gcRegion) populatedFields.push(`GC Region: ${gcRegion}`);
            if (gcClientId) populatedFields.push(`GC Client ID: ${gcClientId}`);
            if (gcRedirectUrl) populatedFields.push(`GC Redirect URL: ${gcRedirectUrl}`);
            if (gcConversationId) populatedFields.push(`GC Conversation ID: ${gcConversationId}`);
            if (audiohookUrl) populatedFields.push(`AudioHook URL: ${audiohookUrl}`);
            if (iframeUrl) populatedFields.push(`Iframe URL: ${iframeUrl}`);
            if (organizationId) populatedFields.push(`Organization ID: ${organizationId}`);
            if (conversationId) populatedFields.push(`Conversation ID: ${conversationId}`);
            if (conversationProfileId) populatedFields.push(`Profile ID: ${conversationProfileId}`);
            if (contactName) populatedFields.push(`Contact Name: ${contactName}`);
            if (contactEmail) populatedFields.push(`Contact Email: ${contactEmail}`);
            if (contactPhone) populatedFields.push(`Contact Phone: ${contactPhone}`);
            if (autoListen) populatedFields.push(`AutoListen: ${autoListen}`);
            
            if (populatedFields.length > 0) {
                logMessage('URL parameters loaded:', { populatedFields });
                logGcTranscriptionMessage('URL parameters loaded:', { populatedFields });
            }
        }
        
        // ==========================================================================
        // INITIALIZATION & SETUP
        // ==========================================================================
        
        /**
         * Main initialization when page loads
         * Sets up the demo, form panel state, and checks for auto-start conditions
         */
        document.addEventListener('DOMContentLoaded', function() {
            initializeDemo();
            initializeFormPanelState();
            initializeCollapsibleSections();
            checkForAutoStartCallSequence();
            checkForAutoListenSequence();
        });
        
        /**
         * Initializes the demo by parsing URL parameters and creating the communication wrapper
         * Sets up all callbacks for iframe communication, AudioHook, and Genesys Cloud integration
         */
        function initializeDemo() {
            // Parse URL parameters for Genesys Cloud configuration
            populateFromUrlParameters();
            
            // Create the communication wrapper
            communicationWrapper = new IframeCommunicationWrapper({
                targetOrigin: '*', // For demo purposes - in production, use specific domain
                onMessageReceived: function(messageData) {
                    logMessage('Received from iframe:', messageData);
                },
                onConnectionEstablished: function() {
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    logMessage('Connection established with iframe');
                },
                onConversationIdChanged: function(conversationId) {
                    const displayElement = document.getElementById('activeConversationId');
                    if (conversationId) {
                        displayElement.textContent = conversationId;
                        displayElement.style.color = '#28a745'; // Green for active
                    } else {
                        displayElement.textContent = 'None';
                        displayElement.style.color = '#6c757d'; // Gray for none
                    }
                },
                onAudiohookMessage: function(messageData) {
                    logAudiohookMessage('AudioHook message received:', messageData);
                },
                onAudiohookStatusChanged: function(status) {
                    updateAudiohookStatus(status);
                },
                onGcTranscriptionMessage: function(messageData) {
                    logGcTranscriptionMessage('GC Transcription message received:', messageData);
                    // Note: Auto-forwarding to iframe is handled by the wrapper if enabled
                },
                onGcAuthStatusChanged: function(status) {
                    updateGcAuthStatus(status);
                },
                onGcTranscriptionStatusChanged: function(status) {
                    updateGcTranscriptionStatus(status);
                },
                onGcConversationNotification: function(messageData) {
                    logGcConversationNotification('GC Conversation notification received:', messageData);
                },
                onGcConversationStatusChanged: function(status) {
                    updateGcConversationStatus(status);
                },
                onGcMessageStatusChanged: function(status) {
                    updateGcMessageStatus(status);
                },
                onConversationTrackingUpdate: function(conversations) {
                    updateTrackedConversationsDisplay(conversations);
                },
                onActiveConversationChanged: function(conversationId) {
                    updateActiveConversationId(conversationId);
                },
                onNewNotesReceived: function(responseDetails) {
                    displayLatestNotes(responseDetails);
                },
                onMessageTracked: function(messageData) {
                    displayTrackedMessage(messageData);
                }
            });
            
            // Initialize with the iframe element
            const iframeElement = document.getElementById('demoIframe');
            communicationWrapper.initialize(iframeElement);
            
            // Auto-fill redirect URL with current page URL
            const currentUrl = window.location.origin + window.location.pathname;
            document.getElementById('gcRedirectUrlInput').value = currentUrl;
            
            // Check SDK loading status
            setTimeout(() => {
                if (typeof platformClient !== 'undefined') {
                    logGcTranscriptionMessage('PureCloud Platform Client SDK loaded successfully');
                } else if (typeof window.platformClient !== 'undefined') {
                    logGcTranscriptionMessage('PureCloud Platform Client SDK loaded on window object');
                } else {
                    logGcTranscriptionMessage('WARNING: PureCloud Platform Client SDK not detected. Please check console for errors.');
                    console.log('Available window properties:', Object.keys(window).filter(key => key.toLowerCase().includes('platform') || key.toLowerCase().includes('pure')));
                }
            }, 1000);
            
            logMessage('Demo initialized. Ready to communicate with iframe.');
        }
        
        // Helper function to load iframe with new URL and organization ID
        // ==========================================================================
        // IFRAME MANAGEMENT FUNCTIONS
        // ==========================================================================
        
        /**
         * Loads the iframe with the current URL settings and organization ID
         * Constructs the full URL by appending organization ID as query parameter
         */
        function loadIframeWithNewUrl() {
            const baseUrl = document.getElementById('iframeUrlInput').value;
            const organizationId = document.getElementById('organizationIdInput').value;
            
            // Construct the full URL with organization_id query parameter
            let fullUrl = baseUrl;
            if (organizationId && organizationId.trim() !== '') {
                fullUrl += '?organization_id=' + encodeURIComponent(organizationId.trim());
            }
            
            const iframe = document.getElementById('demoIframe');
            iframe.src = fullUrl;
            logMessage('Loading iframe with URL: ' + fullUrl);
        }
        
        // Helper function to log messages
        function logMessage(message, data = null) {
            const logElement = document.getElementById('messageLog');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            logElement.textContent += logEntry + '\n\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // ==========================================================================
        // LOGGING & MESSAGE DISPLAY FUNCTIONS
        // ==========================================================================
        
        /**
         * Clears the main iframe communication message log
         */
        function clearMessageLog() {
            document.getElementById('messageLog').textContent = '';
        }
        
        // ==========================================================================
        // AUDIOHOOK FUNCTIONS
        // ==========================================================================
        /**
         * Logs AudioHook messages with timestamp to the AudioHook message log
         * @param {string} message - The message to log
         * @param {Object} data - Optional data object to include
         */
        function logAudiohookMessage(message, data = null) {
            const logElement = document.getElementById('audiohookMessageLog');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            logElement.textContent += logEntry + '\n\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearAudiohookLog() {
            document.getElementById('audiohookMessageLog').textContent = 'Ready to receive AudioHook messages...';
        }
        
        function updateAudiohookStatus(status) {
            const statusElement = document.getElementById('audiohookStatus');
            const connectBtn = document.getElementById('audiohookConnectBtn');
            const disconnectBtn = document.getElementById('audiohookDisconnectBtn');
            
            statusElement.textContent = status;
            
            // Update button states and status colors based on connection status
            if (status === 'Connected') {
                statusElement.style.color = '#28a745'; // Green
                statusElement.style.backgroundColor = '#d4edda';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else if (status.startsWith('Connecting') || status.startsWith('Reconnecting')) {
                statusElement.style.color = '#ffc107'; // Yellow
                statusElement.style.backgroundColor = '#fff3cd';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.style.color = '#6c757d'; // Gray
                statusElement.style.backgroundColor = '#f8f9fa';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function connectToAudiohook() {
            const audiohookUrl = document.getElementById('audiohookUrlInput').value;
            const conversationId = document.getElementById('conversationIdInput').value;
            
            if (!audiohookUrl || audiohookUrl.trim() === '') {
                alert('Please enter an AudioHook WebSocket URL');
                return;
            }
            
            if (!audiohookUrl.startsWith('ws://') && !audiohookUrl.startsWith('wss://')) {
                alert('AudioHook URL must start with ws:// or wss://');
                return;
            }
            
            if (!conversationId || conversationId.trim() === '') {
                alert('Please enter a Conversation ID for AudioHook initialization');
                return;
            }
            
            if (communicationWrapper) {
                logAudiohookMessage('Connecting to AudioHook...', { 
                    url: audiohookUrl, 
                    conversationId: conversationId 
                });
                communicationWrapper.connectToAudiohook(audiohookUrl, conversationId);
            }
        }
        
        function disconnectFromAudiohook() {
            if (communicationWrapper) {
                logAudiohookMessage('Disconnecting from AudioHook...');
                communicationWrapper.disconnectFromAudiohook();
            }
        }
        
        // Genesys Cloud specific functions
        function logGcTranscriptionMessage(message, data = null) {
            const logElement = document.getElementById('gcTranscriptionMessageLog');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            logElement.textContent += logEntry + '\n\n';
            logElement.scrollTop = logElement.scrollHeight;

            

        }
        
        function clearGcTranscriptionLog() {
            document.getElementById('gcTranscriptionMessageLog').textContent = 'Ready to receive Genesys Cloud transcription messages...';
        }
        
        // ==========================================================================
        // GENESYS CLOUD CONVERSATION NOTIFICATIONS FUNCTIONS
        // ==========================================================================
        
        /**
         * Logs Genesys Cloud conversation notification messages with timestamp
         * @param {string} message - The message to log
         * @param {Object} data - Optional data object to include
         */
        function logGcConversationNotification(message, data = null) {
            const logElement = document.getElementById('gcConversationNotificationLog');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            logElement.textContent += logEntry + '\n\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            // Recalculate collapsible section heights after adding content
            setTimeout(recalculateCollapsibleHeights, 50);
        }
        
        function clearGcConversationNotificationLog() {
            document.getElementById('gcConversationNotificationLog').textContent = 'Ready to receive Genesys Cloud conversation notifications...';
        }
        
        function updateGcConversationStatus(status) {
            const statusElement = document.getElementById('gcConversationStatus');
            const connectBtn = document.getElementById('gcConversationConnectBtn');
            const disconnectBtn = document.getElementById('gcConversationDisconnectBtn');
            
            statusElement.textContent = status;
            
            if (status === 'Connected') {
                statusElement.style.color = '#28a745'; // Green
                statusElement.style.backgroundColor = '#d4edda';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else if (status === 'Connecting...') {
                statusElement.style.color = '#ffc107'; // Yellow
                statusElement.style.backgroundColor = '#fff3cd';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.style.color = '#6c757d'; // Gray
                statusElement.style.backgroundColor = '#f8f9fa';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function updateGcMessageStatus(status) {
            const statusElement = document.getElementById('gcMessageStatus');
            const connectBtn = document.getElementById('gcMessageConnectBtn');
            const disconnectBtn = document.getElementById('gcMessageDisconnectBtn');
            
            statusElement.textContent = status;
            
            if (status === 'Connected') {
                statusElement.style.color = '#28a745'; // Green
                statusElement.style.backgroundColor = '#d4edda';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else if (status === 'Connecting...' || status === 'Authenticating...') {
                statusElement.style.color = '#ffc107'; // Yellow
                statusElement.style.backgroundColor = '#fff3cd';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.style.color = '#6c757d'; // Gray
                statusElement.style.backgroundColor = '#f8f9fa';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        /**
         * Connects to Genesys Cloud conversation notifications for a specific user
         * Uses the user ID from the form input
         */
        function connectToConversationNotifications() {
            const userId = document.getElementById('gcUserIdInput').value;
            
            if (!userId || userId.trim() === '') {
                alert('Please enter a Genesys Cloud User ID');
                return;
            }
            
            if (communicationWrapper && communicationWrapper.isGenesysCloudAuthenticated()) {
                logGcConversationNotification('Connecting to Genesys Cloud conversation notifications...', {
                    userId: userId
                });
                
                communicationWrapper.connectToGcConversationNotifications(userId).then(success => {
                    if (success) {
                        logGcConversationNotification('Successfully connected to Genesys Cloud conversation notifications');
                    } else {
                        logGcConversationNotification('Failed to connect to Genesys Cloud conversation notifications');
                    }
                });
            } else {
                alert('Please authenticate with Genesys Cloud first');
            }
        }
        
        function disconnectFromConversationNotifications() {
            if (communicationWrapper) {
                logGcConversationNotification('Disconnecting from Genesys Cloud conversation notifications...');
                communicationWrapper.disconnectFromGcConversationNotifications();
            }
        }
        
        function connectToMessageNotifications() {
            const userId = document.getElementById('gcUserIdInput').value;
            
            if (!userId || userId.trim() === '') {
                alert('Please enter a Genesys Cloud User ID');
                return;
            }
            
            if (communicationWrapper && communicationWrapper.isGenesysCloudAuthenticated()) {
                logGcConversationNotification('Connecting to Genesys Cloud message notifications...', {
                    userId: userId
                });
                
                communicationWrapper.connectToGcMessageNotifications(userId).then(success => {
                    if (success) {
                        logGcConversationNotification('Successfully connected to Genesys Cloud message notifications');
                    } else {
                        logGcConversationNotification('Failed to connect to Genesys Cloud message notifications');
                    }
                });
            } else {
                alert('Please authenticate with Genesys Cloud first');
            }
        }
        
        function disconnectFromMessageNotifications() {
            if (communicationWrapper) {
                logGcConversationNotification('Disconnecting from Genesys Cloud message notifications...');
                communicationWrapper.disconnectFromGcMessageNotifications();
            }
        }
        
        /**
         * Updates the tracked conversations display
         * @param {Array} conversations - Array of conversation objects
         */
        function updateTrackedConversationsDisplay(conversations) {
            const displayElement = document.getElementById('trackedConversationsDisplay');
            
            if (!conversations || conversations.length === 0) {
                displayElement.innerHTML = 'No conversations tracked yet...';
                return;
            }
            
            // Sort conversations by last updated (most recent first)
            const sortedConversations = conversations.sort((a, b) => 
                new Date(b.lastUpdated) - new Date(a.lastUpdated)
            );
            
            let html = '<div style="font-family: monospace; font-size: 12px;">';
            
            sortedConversations.forEach(conv => {
                const stateColor = getStateColor(conv.currentState);
                const timeSinceUpdate = getTimeSince(conv.lastUpdated);
                
                // Check if this is the active conversation
                const isActive = communicationWrapper && 
                                communicationWrapper.getMostRecentActiveConversationId() === conv.id;
                const backgroundStyle = isActive ? 
                    'background: linear-gradient(135deg, #e8f5e8, #f9f9f9); border: 2px solid #28a745;' : 
                    'background: #f9f9f9; border: 1px solid #ddd;';
                
                const activeIndicator = isActive ? '🟢 ' : '';
                
                html += `
                    <div style="${backgroundStyle} margin: 5px 0; padding: 8px;">
                        <div style="font-weight: bold; color: #333;">
                            ${activeIndicator}📞 ${conv.customerName || 'Unknown'} 
                            <span style="color: ${stateColor}; font-size: 11px;">[${conv.currentState.toUpperCase()}]</span>
                            <span style="color: #666; font-size: 10px; float: right;">${timeSinceUpdate}</span>
                            ${isActive ? '<span style="color: #28a745; font-size: 10px; float: right; margin-right: 10px;">[ACTIVE]</span>' : ''}
                        </div>
                        <div style="font-size: 10px; color: #666; margin: 2px 0;">
                            ID: ${conv.id} | Direction: ${conv.direction || 'N/A'} | AA: ${conv.hasAgentAssist ? '✅' : '❌'}
                        </div>
                        <div style="font-size: 10px; color: #888;">
                            States: ${conv.stateHistory.length > 0 ? 
                                conv.stateHistory.map(h => h.state).join(' → ') + ' → ' + conv.currentState : 
                                conv.currentState}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            displayElement.innerHTML = html;
        }
        
        /**
         * Get color for conversation state
         * @param {string} state - The conversation state
         * @returns {string} - CSS color
         */
        function getStateColor(state) {
            switch (state.toLowerCase()) {
                case 'contacting': return '#ffc107';
                case 'dialing': return '#fd7e14';
                case 'connected': return '#28a745';
                case 'disconnected': return '#6c757d';
                case 'terminated': return '#dc3545';
                default: return '#6c757d';
            }
        }
        
        /**
         * Get time since a timestamp in human readable format
         * @param {string} timestamp - ISO timestamp
         * @returns {string} - Human readable time difference
         */
        function getTimeSince(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            
            if (diffSecs < 60) return `${diffSecs}s ago`;
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return past.toLocaleDateString();
        }
        
        /**
         * Clear all tracked conversations
         */
        function clearTrackedConversations() {
            if (communicationWrapper) {
                communicationWrapper.clearTrackedConversations();
            }
        }
        
        /**
         * Update the GC Conversation ID input field with the active conversation
         * @param {string|null} conversationId - The active conversation ID or null if none active
         */
        function updateActiveConversationId(conversationId) {
            const gcConversationIdInput = document.getElementById('gcConversationIdInput');
            
            if (conversationId) {
                console.log(`Setting GC Conversation ID field to active conversation: ${conversationId}`);
                gcConversationIdInput.value = conversationId;
                
                // Visual indicator that this was auto-populated
                gcConversationIdInput.style.backgroundColor = '#d1f2eb';
                gcConversationIdInput.style.borderColor = '#28a745';
                
                // Add a subtle animation to draw attention
                gcConversationIdInput.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                    gcConversationIdInput.style.backgroundColor = '';
                    gcConversationIdInput.style.borderColor = '';
                }, 2000);
                
            } else {
                console.log('No active conversation - clearing GC Conversation ID field');
                gcConversationIdInput.value = '';
                gcConversationIdInput.style.backgroundColor = '';
                gcConversationIdInput.style.borderColor = '';
            }
        }
        
        function clearConversationDetailsLog() {
            const logElement = document.getElementById('conversationDetailsLog');
            logElement.innerHTML = 'Ready to fetch conversation details...';
            logConversationDetails('Log cleared');
        }
        
        function logConversationDetails(message, data = null) {
            const logElement = document.getElementById('conversationDetailsLog');
            const timestamp = new Date().toLocaleTimeString();
            
            if (data) {
                // Format the JSON data nicely
                const formattedData = JSON.stringify(data, null, 2);
                logElement.innerHTML += `<div><strong>[${timestamp}]</strong> ${message}<br><pre style="background: #f0f0f0; padding: 5px; margin: 5px 0; font-size: 11px; max-height: 300px; overflow-y: auto;">${formattedData}</pre></div>`;
            } else {
                logElement.innerHTML += `<div><strong>[${timestamp}]</strong> ${message}</div>`;
            }
            
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateGcAuthStatus(status) {
            const statusElement = document.getElementById('gcAuthStatus');
            const authBtn = document.getElementById('gcAuthBtn');
            const transcriptionConnectBtn = document.getElementById('gcTranscriptionConnectBtn');
            const conversationConnectBtn = document.getElementById('gcConversationConnectBtn');
            const messageConnectBtn = document.getElementById('gcMessageConnectBtn');
            
            statusElement.textContent = status;
            
            if (status.startsWith('Authenticated')) {
                statusElement.style.color = '#28a745'; // Green
                statusElement.style.backgroundColor = '#d4edda';
                authBtn.disabled = true;
                transcriptionConnectBtn.disabled = false;
                conversationConnectBtn.disabled = false;
                messageConnectBtn.disabled = false;
            } else if (status === 'Authenticating...') {
                statusElement.style.color = '#ffc107'; // Yellow
                statusElement.style.backgroundColor = '#fff3cd';
                authBtn.disabled = true;
                transcriptionConnectBtn.disabled = true;
                conversationConnectBtn.disabled = true;
                messageConnectBtn.disabled = true;
            } else {
                statusElement.style.color = '#6c757d'; // Gray
                statusElement.style.backgroundColor = '#f8f9fa';
                authBtn.disabled = false;
                transcriptionConnectBtn.disabled = true;
                conversationConnectBtn.disabled = true;
                messageConnectBtn.disabled = true;
            }
        }
        
        function updateGcTranscriptionStatus(status) {
            const statusElement = document.getElementById('gcTranscriptionStatus');
            const connectBtn = document.getElementById('gcTranscriptionConnectBtn');
            const disconnectBtn = document.getElementById('gcTranscriptionDisconnectBtn');
            
            statusElement.textContent = status;
            
            if (status === 'Connected') {
                statusElement.style.color = '#28a745'; // Green
                statusElement.style.backgroundColor = '#d4edda';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else if (status === 'Connecting...') {
                statusElement.style.color = '#ffc107'; // Yellow
                statusElement.style.backgroundColor = '#fff3cd';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.style.color = '#6c757d'; // Gray
                statusElement.style.backgroundColor = '#f8f9fa';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        // ==========================================================================
        // GENESYS CLOUD INTEGRATION FUNCTIONS
        // ==========================================================================
        
        /**
         * Initiates Genesys Cloud OAuth authentication flow
         * Uses the region, client ID, and redirect URL from form inputs
         */
        function authenticateGenesysCloud() {
            const region = document.getElementById('gcRegionInput').value;
            const clientId = document.getElementById('gcClientIdInput').value;
            const redirectUrl = document.getElementById('gcRedirectUrlInput').value;
            
            if (!region || region.trim() === '') {
                alert('Please enter a Genesys Cloud region');
                return;
            }
            
            if (!clientId || clientId.trim() === '') {
                alert('Please enter a Genesys Cloud Client ID');
                return;
            }
            
            if (!redirectUrl || redirectUrl.trim() === '') {
                alert('Please enter a redirect URL');
                return;
            }
            
            // Check if SDK is loaded
            if (typeof platformClient === 'undefined' && typeof window.platformClient === 'undefined') {
                alert('PureCloud Platform Client SDK is not loaded. Please refresh the page and try again.');
                logGcTranscriptionMessage('ERROR: PureCloud SDK not loaded. Available globals:', Object.keys(window));
                return;
            }
            
            if (communicationWrapper) {
                // Initialize and authenticate
                const initialized = communicationWrapper.initializeGenesysCloud(region, clientId, redirectUrl);
                if (initialized) {
                    logGcTranscriptionMessage('Initializing Genesys Cloud...', {
                        region: region,
                        clientId: clientId,
                        redirectUrl: redirectUrl
                    });
                    
                    // Perform authentication
                    communicationWrapper.authenticateGenesysCloud().then(success => {
                        if (success) {
                            logGcTranscriptionMessage('Genesys Cloud authentication successful');
                        } else {
                            logGcTranscriptionMessage('Genesys Cloud authentication failed');
                        }
                    }).catch(error => {
                        logGcTranscriptionMessage('Genesys Cloud authentication error:', error);
                    });
                } else {
                    logGcTranscriptionMessage('Failed to initialize Genesys Cloud');
                }
            }
        }
        
        function connectToTranscription() {
            const conversationId = document.getElementById('gcConversationIdInput').value;
            
            if (!conversationId || conversationId.trim() === '') {
                alert('Please enter a Genesys Cloud Conversation ID');
                return;
            }
            
            if (communicationWrapper && communicationWrapper.isGenesysCloudAuthenticated()) {
                logGcTranscriptionMessage('Connecting to Genesys Cloud transcription...', {
                    conversationId: conversationId
                });
                
                communicationWrapper.connectToGcTranscription(conversationId).then(success => {
                    if (success) {
                        logGcTranscriptionMessage('Successfully connected to Genesys Cloud transcription');
                    } else {
                        logGcTranscriptionMessage('Failed to connect to Genesys Cloud transcription');
                    }
                });
            } else {
                alert('Please authenticate with Genesys Cloud first');
            }
        }
        
        function disconnectFromTranscription() {
            if (communicationWrapper) {
                logGcTranscriptionMessage('Disconnecting from Genesys Cloud transcription...');
                communicationWrapper.disconnectFromGcTranscription();
            }
        }
        
        function getConversationDetails() {
            // Use the GC conversation ID input field (same as transcription subscription)
            const conversationId = document.getElementById('gcConversationIdInput').value;
            if (!conversationId) {
                logConversationDetails('❌ Error: No GC conversation ID provided');
                return;
            }
            
            const authStatus = document.getElementById('gcAuthStatus').textContent;
            if (!authStatus.startsWith('Authenticated')) {
                logConversationDetails('❌ Error: Must authenticate with Genesys Cloud first');
                return;
            }
            
            if (!communicationWrapper || !communicationWrapper.gcPlatformClient) {
                logConversationDetails('❌ Error: Genesys Cloud Platform Client not available');
                return;
            }
            
            logConversationDetails(`🔍 Fetching conversation details for: ${conversationId}...`);
            
            try {
                // Initialize ConversationsApi
                const conversationsApi = new communicationWrapper.gcPlatformClient.ConversationsApi();
                
                // Get conversation details using the SDK
                conversationsApi.getConversation(conversationId)
                    .then((data) => {
                        logConversationDetails('✅ Successfully retrieved conversation details', data);
                        console.log('Conversation details:', data);
                        
                        // Find the external participant - first try participantType === 'External'
                        let externalParticipant = data.participants.find(p => p.participantType === 'External');
                        
                        // If no external participant found, look for participant with purpose === 'customer'
                        if (!externalParticipant) {
                            externalParticipant = data.participants.find(p => p.purpose === 'customer');
                            if (externalParticipant) {
                                logConversationDetails('🔍 Using customer participant as external participant');
                            }
                        }
                        
                        // Determine media type by checking for connected calls or messages
                        let mediaType = 'unknown';
                        for (const participant of data.participants) {
                            // Check calls array for connected state
                            if (participant.calls && participant.calls.length > 0) {
                                const connectedCall = participant.calls.find(call => call.state === 'connected');
                                if (connectedCall) {
                                    mediaType = 'voice';
                                    break;
                                }
                            }
                            // Check messages array for connected state
                            if (participant.messages && participant.messages.length > 0) {
                                const connectedMessage = participant.messages.find(msg => msg.state === 'connected');
                                if (connectedMessage) {
                                    mediaType = 'messaging';
                                    break;
                                }
                            }
                        }
                        
                        // Store the media type globally for use in call sequences
                        lastDetectedMediaType = mediaType;
                        logConversationDetails(`📞 Media Type: ${mediaType}`);
                        
                        if (externalParticipant) {
                            // Populate Contact Name from external participant name
                            if (externalParticipant.name) {
                                document.getElementById('contactNameInput').value = externalParticipant.name;
                                logConversationDetails(`📝 Updated Contact Name: ${externalParticipant.name}`);
                            }
                            
                            // Populate Contact Phone from external participant address (last 10 digits only)
                            if (externalParticipant.address) {
                                // Extract only numbers from the address and take the last 10 digits
                                const numbersOnly = externalParticipant.address.replace(/\D/g, '');
                                const last10Digits = numbersOnly.slice(-10);
                                
                                document.getElementById('contactPhoneInput').value = last10Digits;
                                logConversationDetails(`📞 Updated Contact Phone: ${last10Digits} (from ${externalParticipant.address})`);
                            }
                            
                            logConversationDetails(`✅ Form fields updated with external participant data (${externalParticipant.purpose || 'external'})`);
                        } else {
                            logConversationDetails('⚠️ No external participant or customer participant found in conversation');
                        }
                    })
                    .catch((error) => {
                        logConversationDetails('❌ Error fetching conversation details', error);
                        console.error('Error fetching conversation details:', error);
                    });
            } catch (error) {
                logConversationDetails('❌ Error initializing Conversations API', error);
                console.error('Error initializing Conversations API:', error);
            }
        }
        
        // Auto-forwarding toggle functions
        function toggleAutoForwardTranscription() {
            const checkbox = document.getElementById('autoForwardTranscription');
            if (communicationWrapper) {
                communicationWrapper.setAutoForwardTranscription(checkbox.checked);
            }
        }
        
        function toggleAutoForwardAudiohook() {
            const checkbox = document.getElementById('autoForwardAudiohook');
            if (communicationWrapper) {
                communicationWrapper.setAutoForwardAudiohook(checkbox.checked);
            }
        }
        
        function toggleAutoForwardMessages() {
            const checkbox = document.getElementById('autoForwardMessages');
            if (communicationWrapper) {
                communicationWrapper.setAutoForwardMessages(checkbox.checked);
            }
        }
        
        function toggleFilterWorkflowMessages() {
            const checkbox = document.getElementById('filterWorkflowMessages');
            if (communicationWrapper) {
                communicationWrapper.setFilterWorkflowMessages(checkbox.checked);
            }
        }
        
        function toggleAutoHandleIncomingCalls() {
            const checkbox = document.getElementById('autoHandleIncomingCalls');
            if (communicationWrapper) {
                communicationWrapper.setAutoHandleIncomingCalls(checkbox.checked);
            }
        }
        
        // ==========================================================================
        // NOTES DISPLAY FUNCTIONS
        // ==========================================================================
        
        /**
         * Display the latest notes received from iframe in a user-friendly format
         * @param {Object} responseDetails - The notes response details
         */
        function displayLatestNotes(responseDetails) {
            const displayElement = document.getElementById('latestNotesDisplay');
            const timestamp = new Date().toLocaleTimeString();
            
            if (!responseDetails || !responseDetails.notes) {
                displayElement.innerHTML = `<div style="color: #dc3545;">[${timestamp}] Invalid notes data received</div>`;
                return;
            }
            
            const { conversation, notes } = responseDetails;
            const conversationId = conversation?.id || 'Unknown';
            
            // Create user-friendly display
            let html = `<div style="font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0; background: #f8f9fa;">`;
            html += `<div style="font-weight: bold; color: #333; margin-bottom: 8px;">📝 New Notes Received</div>`;
            html += `<div style="color: #666; font-size: 11px; margin-bottom: 10px;">Time: ${timestamp} | Conversation: ${conversationId}</div>`;
            
            if (notes.sections && notes.sections.length > 0) {
                html += `<div style="background: white; padding: 8px; border-radius: 4px;">`;
                
                notes.sections.forEach(section => {
                    const friendlyKey = getFriendlyKeyName(section.key);
                    const friendlyValue = getFriendlyValue(section.value);
                    const keyColor = getKeyColor(section.key);
                    
                    html += `<div style="margin: 6px 0; display: flex; align-items: flex-start;">`;
                    html += `<span style="font-weight: bold; color: ${keyColor}; min-width: 120px; margin-right: 10px;">${friendlyKey}:</span>`;
                    html += `<span style="flex: 1;">${friendlyValue}</span>`;
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
            
            if (notes.entities && notes.entities.length > 0) {
                html += `<div style="margin-top: 10px; padding: 8px; background: #e8f4f8; border-radius: 4px;">`;
                html += `<div style="font-weight: bold; color: #0056b3; margin-bottom: 5px;">🏷️ Entities:</div>`;
                notes.entities.forEach(entity => {
                    html += `<span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; margin: 2px;">${entity}</span>`;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            
            // Add to the display (keeping latest note at top)
            displayElement.innerHTML = html + displayElement.innerHTML;
            
            console.log('Latest notes displayed in UI');
        }
        
        /**
         * Get user-friendly name for note keys
         * @param {string} key - The raw key name
         * @returns {string} - User-friendly key name
         */
        function getFriendlyKeyName(key) {
            const keyMappings = {
                'situation': '🔍 Situation',
                'action': '⚡ Action Taken',
                'resolution': '✅ Resolution',
                'customer_satisfaction': '😊 Customer Satisfaction',
                'reason_for_cancellation': '❌ Cancellation Reason',
                'summary': '📋 Summary',
                'next_steps': '👉 Next Steps',
                'issue_type': '🏷️ Issue Type',
                'priority': '🔥 Priority',
                'outcome': '🎯 Outcome'
            };
            
            return keyMappings[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        /**
         * Get user-friendly display value
         * @param {string} value - The raw value
         * @returns {string} - User-friendly value
         */
        function getFriendlyValue(value) {
            if (!value || value === 'N' || value === 'N/A') {
                return '<span style="color: #6c757d; font-style: italic;">Not specified</span>';
            }
            
            if (value === 'Y' || value === 'Yes') {
                return '<span style="color: #28a745; font-weight: bold;">✓ Yes</span>';
            }
            
            if (value === 'No') {
                return '<span style="color: #dc3545; font-weight: bold;">✗ No</span>';
            }
            
            return value;
        }
        
        /**
         * Get color for different key types
         * @param {string} key - The key name
         * @returns {string} - CSS color
         */
        function getKeyColor(key) {
            const colorMappings = {
                'situation': '#007bff',
                'action': '#28a745',
                'resolution': '#ffc107',
                'customer_satisfaction': '#e83e8c',
                'reason_for_cancellation': '#dc3545'
            };
            
            return colorMappings[key] || '#6c757d';
        }
        
        /**
         * Clear the notes display
         */
        function clearLatestNotes() {
            const displayElement = document.getElementById('latestNotesDisplay');
            displayElement.innerHTML = 'No notes received yet...';
        }
        
        // ==========================================================================
        // MESSAGE TRACKER FUNCTIONS
        // ==========================================================================
        
        /**
         * Display a tracked message in the message tracker
         * Rebuilds the entire display sorted by time to handle out-of-order messages
         * @param {Object} messageData - The tracked message data
         */
        function displayTrackedMessage(messageData) {
            rebuildMessageTrackerDisplay();
            console.log(`📨 Message tracker updated: ${messageData.messageId}`);
        }
        
        /**
         * Rebuild the entire message tracker display sorted by time (newest first)
         */
        function rebuildMessageTrackerDisplay() {
            const displayElement = document.getElementById('messageTrackerDisplay');
            
            if (!communicationWrapper) {
                displayElement.innerHTML = 'Communication wrapper not initialized...';
                return;
            }
            
            // Get all tracked messages and sort by time (newest first)
            const allMessages = communicationWrapper.getTrackedMessages();
            allMessages.sort((a, b) => new Date(b.messageTime) - new Date(a.messageTime));
            
            if (allMessages.length === 0) {
                displayElement.innerHTML = 'No messages tracked yet...';
                return;
            }
            
            // Clear and rebuild display
            displayElement.innerHTML = '';
            
            allMessages.forEach(messageData => {
                const timestamp = new Date(messageData.messageTime).toLocaleString();
                
                // Create message display entry
                const messageEntry = document.createElement('div');
                messageEntry.style.cssText = `
                    font-family: monospace; 
                    font-size: 11px; 
                    padding: 8px; 
                    margin: 4px 0; 
                    border: 1px solid #ddd; 
                    border-radius: 4px; 
                    background: #ffffff;
                    border-left: 4px solid ${getParticipantColor(messageData.participantPurpose)};
                `;
                
                const messageText = messageData.messageText || 'Loading...';
                const textDisplay = messageText.length > 100 ? 
                    messageText.substring(0, 100) + '...' : 
                    messageText;
                
                messageEntry.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: bold; color: ${getParticipantColor(messageData.participantPurpose)};">
                            ${getParticipantIcon(messageData.participantPurpose)} ${messageData.participantName} (${messageData.participantPurpose})
                        </span>
                        <span style="color: #6c757d; font-size: 10px;">${timestamp}</span>
                    </div>
                    <div style="margin: 2px 0;">
                        <span style="color: #495057;">Message ID:</span> 
                        <span style="font-family: monospace; background: #f8f9fa; padding: 2px 4px; border-radius: 2px;">${messageData.messageId}</span>
                    </div>
                    <div style="margin: 2px 0;">
                        <span style="color: #495057;">Status:</span> 
                        <span style="color: ${getMessageStatusColor(messageData.messageStatus)}; font-weight: bold;">${messageData.messageStatus}</span>
                        <span style="color: #6c757d; margin-left: 10px;">Type: ${messageData.messageType}</span>
                    </div>
                    <div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid ${getParticipantColor(messageData.participantPurpose)};">
                        <div style="color: #495057; font-weight: bold; margin-bottom: 3px;">Message Text:</div>
                        <div style="color: #212529; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 12px; line-height: 1.4; word-wrap: break-word;">
                            ${messageText === 'Loading...' ? '<em style="color: #6c757d;">Loading...</em>' : textDisplay}
                        </div>
                        ${messageText.length > 100 ? '<div style="color: #6c757d; font-size: 10px; margin-top: 3px; font-style: italic;">Text truncated (click message ID to view full)</div>' : ''}
                    </div>
                `;
                
                displayElement.appendChild(messageEntry);
            });
            
            // Recalculate collapsible section heights after rebuilding content
            setTimeout(recalculateCollapsibleHeights, 50);
        }
        
        /**
         * Get color for different participant purposes
         * @param {string} purpose - The participant purpose
         * @returns {string} - CSS color
         */
        function getParticipantColor(purpose) {
            const colors = {
                'customer': '#dc3545',   // Red
                'agent': '#28a745',      // Green  
                'workflow': '#ffc107',   // Yellow
                'acd': '#17a2b8',        // Blue
                'unknown': '#6c757d'     // Gray
            };
            return colors[purpose] || colors['unknown'];
        }
        
        /**
         * Get icon for different participant purposes
         * @param {string} purpose - The participant purpose
         * @returns {string} - Icon
         */
        function getParticipantIcon(purpose) {
            const icons = {
                'customer': '👤',
                'agent': '👨‍💼',
                'workflow': '🔄',
                'acd': '📞',
                'unknown': '❓'
            };
            return icons[purpose] || icons['unknown'];
        }
        
        /**
         * Get color for message status
         * @param {string} status - The message status
         * @returns {string} - CSS color
         */
        function getMessageStatusColor(status) {
            const colors = {
                'received': '#28a745',        // Green
                'delivery-success': '#17a2b8', // Blue
                'queued': '#ffc107',          // Yellow
                'sent': '#6c757d',            // Gray
                'failed': '#dc3545'           // Red
            };
            return colors[status] || '#6c757d';
        }
        
        /**
         * Clear the message tracker display
         */
        function clearMessageTracker() {
            const displayElement = document.getElementById('messageTrackerDisplay');
            displayElement.innerHTML = 'No messages tracked yet...';
            
            // Also clear the tracked messages in the wrapper
            if (communicationWrapper) {
                communicationWrapper.clearTrackedMessages();
            }
        }
        
        // ==========================================================================
        // FORM PANEL & UI CONTROL FUNCTIONS
        // ==========================================================================
        
        /**
         * Toggles visibility of the form control panel
         * Updates button text and icon based on current state
         */
        function toggleFormPanel() {
            const controlsPanel = document.querySelector('.controls-panel');
            const toggleBtn = document.getElementById('panelToggleBtn');
            
            if (isFormPanelVisible) {
                // Hide the form panel
                controlsPanel.classList.add('hidden');
                toggleBtn.classList.add('hide-mode');
                toggleBtn.querySelector('span:first-child').textContent = '👁️';
                isFormPanelVisible = false;
            } else {
                // Show the form panel
                controlsPanel.classList.remove('hidden');
                toggleBtn.classList.remove('hide-mode');
                toggleBtn.querySelector('span:first-child').textContent = '🔍';
                isFormPanelVisible = true;
            }
        }
        
        function initializeFormPanelState() {
            // Check for query parameter to set initial state
            const urlParams = new URLSearchParams(window.location.search);
            const hidePanel = urlParams.get('hidePanel') === 'true';
            
            if (hidePanel) {
                // Set initial state without animation
                isFormPanelVisible = true; // Set to true so toggle function will hide it
                toggleFormPanel();
            }
        }
        
        /**
         * Toggle collapsible section visibility
         * @param {string} sectionId - The ID of the section to toggle
         */
        function toggleCollapsibleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = document.querySelector(`[onclick*="${sectionId}"]`);
            const indicator = header ? header.querySelector('.collapsible-indicator') : null;
            
            if (!content) return;
            
            // Check if collapsed - either has collapsed class or has max-height of 0 (default collapsed state)
            const isCollapsed = content.classList.contains('collapsed') || content.style.maxHeight === '0px' || !content.style.maxHeight;
            
            if (isCollapsed) {
                // Expand the section
                content.classList.remove('collapsed');
                
                // Force reflow to ensure accurate height calculation
                content.offsetHeight;
                
                // Set initial height and then recalculate after a brief moment for dynamic content
                content.style.maxHeight = content.scrollHeight + 'px';
                
                // Recalculate height after a short delay to account for dynamic content
                setTimeout(() => {
                    if (!content.classList.contains('collapsed')) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                }, 100);
                
                if (indicator) indicator.classList.remove('collapsed');
                
                // Store expanded state
                localStorage.setItem(`section_${sectionId}_collapsed`, 'false');
            } else {
                // Collapse the section
                content.style.maxHeight = content.scrollHeight + 'px';
                // Force reflow
                content.offsetHeight;
                content.style.maxHeight = '0px';
                content.classList.add('collapsed');
                if (indicator) indicator.classList.add('collapsed');
                
                // Store collapsed state
                localStorage.setItem(`section_${sectionId}_collapsed`, 'true');
            }
        }
        
        /**
         * Initialize collapsible sections based on stored preferences
         */
        function initializeCollapsibleSections() {
            const sections = document.querySelectorAll('.collapsible-content');
            
            sections.forEach(section => {
                const sectionId = section.id;
                if (!sectionId) return;
                
                // Check stored preference - if no preference exists, default to collapsed
                const storedPreference = localStorage.getItem(`section_${sectionId}_collapsed`);
                const isCollapsed = storedPreference !== null ? storedPreference === 'true' : true; // Default to collapsed
                
                if (isCollapsed) {
                    // Immediately collapse without animation
                    section.style.maxHeight = '0px';
                    section.classList.add('collapsed');
                    
                    const header = document.querySelector(`[onclick*="${sectionId}"]`);
                    const indicator = header ? header.querySelector('.collapsible-indicator') : null;
                    if (indicator) indicator.classList.add('collapsed');
                } else {
                    // Set initial max-height for expanded sections
                    // Use setTimeout to ensure all content is rendered
                    setTimeout(() => {
                        section.style.maxHeight = section.scrollHeight + 'px';
                    }, 50);
                }
            });
        }
        
        /**
         * Recalculate heights for all expanded collapsible sections
         * Useful when content is dynamically added (like log messages)
         */
        function recalculateCollapsibleHeights() {
            const expandedSections = document.querySelectorAll('.collapsible-content:not(.collapsed)');
            expandedSections.forEach(section => {
                if (section.style.maxHeight && section.style.maxHeight !== '0px') {
                    section.style.maxHeight = section.scrollHeight + 'px';
                }
            });
        }
        
        function checkForAutoStartCallSequence() {
            // Check if GC conversation ID is passed in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const gcConversationId = urlParams.get('gc_conversationId');
            
            if (gcConversationId) {
                // Set the conversation ID in the form if provided
                //document.getElementById('conversationIdInput').value = gcConversationId;
                
                // Auto-start the call sequence after a brief delay to ensure everything is initialized
                setTimeout(() => {
                    updateCallSequenceStatus('🚀 Auto-starting call sequence (gc_conversationId provided in URL)...');
                    startNewCallSequence();
                }, 1000);
            }
        }
        
        // ==========================================================================
        // AUTOMATED CALL SEQUENCE FUNCTIONS
        // ==========================================================================
        
        /**
         * Updates the call sequence status display with timestamped messages
         * @param {string} message - Status message to display
         * @param {boolean} isError - Whether this is an error message (shows in red)
         */
        function updateCallSequenceStatus(message, isError = false) {
            const statusDiv = document.getElementById('callSequenceStatus');
            const timestamp = new Date().toLocaleTimeString();
            const style = isError ? 'color: red; font-weight: bold;' : '';
            statusDiv.innerHTML += `<div style="${style}">[${timestamp}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        function clearCallSequenceStatus() {
            document.getElementById('callSequenceStatus').innerHTML = 'Ready to start new call sequence';
        }
        
        function generateRandomConversationId() {
            // Generate a random conversation ID that always starts with a letter
            const letters = 'abcdefghijklmnopqrstuvwxyz';
            const alphanumeric = 'abcdefghijklmnopqrstuvwxyz0123456789';
            
            // Start with a random letter
            let result = letters.charAt(Math.floor(Math.random() * letters.length));
            
            // Add 15 more random alphanumeric characters
            for (let i = 1; i < 16; i++) {
                result += alphanumeric.charAt(Math.floor(Math.random() * alphanumeric.length));
            }
            
            return result;
        }
        
        /**
         * Executes the complete automated call sequence workflow
         * Steps: Load iframe → Auth GC → Get conversation details → Join → Activate → Connect transcription
         * Handles errors and prevents concurrent executions
         * @returns {Promise<void>}
         */
        async function startNewCallSequence() {
            if (callSequenceInProgress) {
                updateCallSequenceStatus('❌ Call sequence already in progress', true);
                return;
            }
            
            callSequenceInProgress = true;
            clearCallSequenceStatus();
            updateCallSequenceStatus('🚀 Starting new call sequence...');
            
            try {
                // Step 1: Load iframe with current settings
                updateCallSequenceStatus('📋 Step 1: Loading iframe with current settings...');
                loadIframeWithNewUrl();
                
                // Wait for iframe to load
                await new Promise(resolve => setTimeout(resolve, 2000));
                updateCallSequenceStatus('✅ Iframe loaded successfully');
                
                // Step 2: Authenticate with Genesys Cloud
                updateCallSequenceStatus('🔐 Step 2: Authenticating with Genesys Cloud...');
                authenticateGenesysCloud();
                
                // Wait for authentication
                await waitForGenesysAuth();
                updateCallSequenceStatus('✅ Genesys Cloud authentication successful');
                
                // Step 3: Get Conversation Details
                updateCallSequenceStatus('🔍 Step 3: Getting conversation details...');
                getConversationDetails();
                
                // Wait for conversation details to complete
                await new Promise(resolve => setTimeout(resolve, 2000));
                updateCallSequenceStatus('✅ Conversation details retrieved and form populated');
                
                // Check if conversation ID was provided via URL, if not randomize it
                const urlParams = new URLSearchParams(window.location.search);
                //const providedConversationId = urlParams.get('gc_conversationId');
                
                //if (!providedConversationId) {
                    // Randomize conversation ID for join/activate if not provided via URL
                    const newConversationId = generateRandomConversationId();
                    document.getElementById('conversationIdInput').value = newConversationId;
                    updateCallSequenceStatus(`🎲 Updated conversation ID to: ${newConversationId}`);
                //} else {
                 //   updateCallSequenceStatus(`📋 Using provided conversation ID for join/activate`);
                //}
                
                // Step 4: Send join conversation message
                updateCallSequenceStatus('📞 Step 4: Joining conversation...');
                sendJoinConversationMessage();
                
                // Wait for conversation joined response
                await waitForConversationJoined();
                updateCallSequenceStatus('✅ Conversation joined successfully');
                
                // Step 5: Send activate conversation message
                updateCallSequenceStatus('🔄 Step 5: Activating conversation...');
                sendActivateConversationMessage();
                
                // Wait a moment for activation
                await new Promise(resolve => setTimeout(resolve, 1000));
                updateCallSequenceStatus('✅ Conversation activated successfully');
                
                // Step 6: Connect to appropriate subscription based on media type
                if (lastDetectedMediaType === 'voice') {
                    updateCallSequenceStatus('🎙️ Step 6: Voice conversation detected - Connecting transcription...');
                    connectToTranscription();
                    
                    // Wait for transcription connection
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    updateCallSequenceStatus('✅ Transcription connected successfully');
                    
                } else if (lastDetectedMediaType === 'messaging') {
                    updateCallSequenceStatus('💬 Step 6: Messaging conversation detected - Connecting message subscription...');
                    
                    // For messaging, we need a user ID to connect to message notifications
                    // Get the user ID from the auth info or use a default
                    const userId = document.getElementById('gcUserIdInput').value;
                    if (userId && userId.trim()) {
                        connectToMessageNotifications();
                        
                        // Wait for message connection
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        updateCallSequenceStatus('✅ Message subscription connected successfully');
                    } else {
                        updateCallSequenceStatus('⚠️ Message subscription skipped - User ID required for message notifications');
                    }
                    
                } else {
                    updateCallSequenceStatus(`⚠️ Step 6: Unknown media type (${lastDetectedMediaType}) - Skipping subscription connection`);
                }
                
                updateCallSequenceStatus('🎉 New call sequence completed successfully!');
                
            } catch (error) {
                updateCallSequenceStatus(`❌ Error in call sequence: ${error.message}`, true);
            } finally {
                callSequenceInProgress = false;
            }
        }
        
        function waitForConversationJoined() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout waiting for conversation joined'));
                }, 10000); // 10 second timeout
                
                // Listen for conversation joined event
                const checkInterval = setInterval(() => {
                    const activeConversationId = document.getElementById('activeConversationId').textContent;
                    if (activeConversationId && activeConversationId !== 'None') {
                        clearTimeout(timeout);
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 500);
            });
        }
        
        function waitForGenesysAuth() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout waiting for Genesys Cloud authentication'));
                }, 15000); // 15 second timeout
                
                // Listen for auth status change
                const checkInterval = setInterval(() => {
                    const authStatus = document.getElementById('gcAuthStatus').textContent;
                    if (authStatus.startsWith('Authenticated')) {
                        clearTimeout(timeout);
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 500);
            });
        }
        
        /**
         * Executes the auto-listen sequence workflow
         * Steps: Load iframe → Auth GC → Connect conversation notifications → Enable auto-handling
         * Triggered when URL contains AutoListen=true parameter
         * @returns {Promise<void>}
         */
        async function startAutoListenSequence() {
            if (autoListenSequenceInProgress) {
                updateCallSequenceStatus('❌ Auto-listen sequence already in progress', true);
                return;
            }
            
            autoListenSequenceInProgress = true;
            clearCallSequenceStatus();
            updateCallSequenceStatus('🔄 Starting auto-listen sequence...');
            
            try {
                // Step 1: Load Agent Assist iframe with current settings
                updateCallSequenceStatus('📋 Step 1: Loading Agent Assist iframe...');
                loadIframeWithNewUrl();
                
                // Wait for iframe to load
                await new Promise(resolve => setTimeout(resolve, 2000));
                updateCallSequenceStatus('✅ Agent Assist iframe loaded successfully');
                
                // Step 2: Authenticate with Genesys Cloud
                updateCallSequenceStatus('🔐 Step 2: Authenticating with Genesys Cloud...');
                authenticateGenesysCloud();
                
                // Wait for authentication
                await waitForGenesysAuth();
                updateCallSequenceStatus('✅ Genesys Cloud authentication successful');
                
                // Step 3: Connect conversation notifications (start listening)
                updateCallSequenceStatus('👂 Step 3: Starting conversation subscription...');
                connectToConversationNotifications();
                
                // Wait for conversation subscription
                await waitForConversationSubscription();
                updateCallSequenceStatus('✅ Conversation subscription active');
                
                // Step 4: Ensure auto-handle incoming calls is enabled
                updateCallSequenceStatus('⚙️ Step 4: Enabling auto-handle incoming calls...');
                const autoHandleCheckbox = document.getElementById('autoHandleIncomingCalls');
                if (autoHandleCheckbox) {
                    autoHandleCheckbox.checked = true;
                    toggleAutoHandleIncomingCalls(); // Apply the setting
                }
                updateCallSequenceStatus('✅ Auto-handle incoming calls enabled');
                
                updateCallSequenceStatus('🎉 Auto-listen sequence completed successfully! Now listening for incoming calls...');
                
            } catch (error) {
                updateCallSequenceStatus(`❌ Error in auto-listen sequence: ${error.message}`, true);
            } finally {
                autoListenSequenceInProgress = false;
            }
        }
        
        function waitForConversationSubscription() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout waiting for conversation subscription'));
                }, 15000); // 15 second timeout
                
                // Listen for conversation subscription status change
                const checkInterval = setInterval(() => {
                    const gcConversationStatus = document.getElementById('gcConversationStatus').textContent;
                    if (gcConversationStatus === 'Connected') {
                        clearTimeout(timeout);
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 500);
            });
        }
        
        /**
         * Check for AutoListen parameter and start sequence if found
         */
        function checkForAutoListenSequence() {
            const autoListen = sessionStorage.getItem('auto_listen');
            
            if (autoListen && autoListen.toLowerCase() === 'true') {
                updateCallSequenceStatus('🚀 AutoListen=true detected in URL - starting auto-listen sequence...');
                
                // Auto-start the sequence after a brief delay to ensure everything is initialized
                setTimeout(() => {
                    startAutoListenSequence();
                }, 1500); // 1.5 second delay for initialization
            }
        }
        
        // ==========================================================================
        // IFRAME COMMUNICATION WRAPPER FUNCTIONS
        // ==========================================================================
        
        /**
         * Sends authorization request message to iframe
         * Delegates to the communication wrapper's sendAuthorizationRequest method
         */
        function sendAuthorizeMessage() {
            if (communicationWrapper) {
                communicationWrapper.sendAuthorizationRequest();
            }
        }
        
        /**
         * Sends join conversation message to iframe with form data
         * Includes conversation ID, profile ID, and contact information
         */
        function sendJoinConversationMessage() {
            const conversationId = document.getElementById('conversationIdInput').value;
            const conversationProfileId = document.getElementById('conversationProfileIdInput').value;
            const contactName = document.getElementById('contactNameInput').value;
            const contactEmail = document.getElementById('contactEmailInput').value;
            const contactPhone = document.getElementById('contactPhoneInput').value;
            
            if (communicationWrapper) {
                communicationWrapper.sendJoinConversation(conversationId, conversationProfileId, contactName, contactEmail, contactPhone);
            }
        }
        
        function sendActivateConversationMessage() {
            // Use the active conversation ID from the iframe response
            const activeConversationId = communicationWrapper ? communicationWrapper.getCurrentConversationId() : null;
            
            if (!activeConversationId) {
                alert('No active conversation ID available. Please join a conversation first.');
                return;
            }
            
            if (communicationWrapper) {
                communicationWrapper.sendActivateConversation(activeConversationId);
            }
        }
        
        function sendLeaveConversationMessage() {
            // Use the active conversation ID from the iframe response
            const activeConversationId = communicationWrapper ? communicationWrapper.getCurrentConversationId() : null;
            
            if (!activeConversationId) {
                alert('No active conversation ID available. Please join a conversation first.');
                return;
            }
            
            if (communicationWrapper) {
                communicationWrapper.sendLeaveConversation(activeConversationId);
            }
        }
        
        /**
         * Sends analyze content message to iframe for AI analysis
         * Uses active conversation ID from iframe response and custom content
         */
        function sendAnalyzeContentMessage() {
            // Use the active conversation ID from the iframe response
            const activeConversationId = communicationWrapper ? communicationWrapper.getCurrentConversationId() : null;
            const messageContent = document.getElementById('messageContentInput').value;
            const speakerType = document.getElementById('speakerTypeSelect').value;
            
            if (!activeConversationId) {
                alert('No active conversation ID available. Please join a conversation first.');
                return;
            }
            
            if (communicationWrapper) {
                communicationWrapper.sendAnalyzeContent(activeConversationId, messageContent, speakerType);
            }
        }
        
        function sendWrapConversationMessage() {
            // Use the active conversation ID from the iframe response
            const activeConversationId = communicationWrapper ? communicationWrapper.getCurrentConversationId() : null;
            
            if (!activeConversationId) {
                alert('No active conversation ID available. Please join a conversation first.');
                return;
            }
            
            if (communicationWrapper) {
                communicationWrapper.sendWrapConversation(activeConversationId);
            }
        }
        
        function simulateAuthSuccess() {
            // Simulate receiving an auth success message from the iframe
            const mockAuthResponse = {
                topic: 'authorized',
                success: true,
                details: {
                    sso: {
                        access_token: 'mock-token-12345'
                    }
                }
            };
            
            logMessage('Simulating auth success response:', mockAuthResponse);
            
            // Manually trigger the message handler
            if (communicationWrapper) {
                communicationWrapper.handleReceivedMessage({ data: mockAuthResponse });
            }
        }
        
        function simulateConversationJoined() {
            // Simulate receiving a conversation-joined message from the iframe
            const mockJoinResponse = {
                topic: 'conversation-joined',
                success: true,
                details: {
                    conversation: {
                        id: '0198e63c-a5ee-73dc-9a91-e8b6ab58b61e',
                        contact_center_conversation_id: 'qrvn6sjly4a74x07'
                    }
                },
                error: null
            };
            
            logMessage('Simulating conversation joined response:', mockJoinResponse);
            
            // Manually trigger the message handler
            if (communicationWrapper) {
                communicationWrapper.handleReceivedMessage({ data: mockJoinResponse });
            }
        }
    </script>
</body>
</html>